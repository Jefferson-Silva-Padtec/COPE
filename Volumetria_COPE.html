<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Produção COPE - Padtec</title>
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* CSS Integrado */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        :root {
            --padtec-orange: #F37021;
            --padtec-black: #1A1A1A;
            --padtec-grey-dark: #2D2D2D;
            --padtec-grey-light: #404040;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--padtec-black);
            background-image: 
                linear-gradient(135deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(225deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(45deg, #1a1a1a 25%, transparent 25%), 
                linear-gradient(315deg, #1a1a1a 25%, #262626 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-attachment: fixed;
            color: #ffffff;
        }

        .letterhead-container {
            position: relative;
            background: #ffffff;
            border-top: 8px solid var(--padtec-orange);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            color: #1a1a1a;
            overflow: hidden;
            width: 100%;
            max-width: 1280px;
            margin: 0 auto;
        }

        .chart-container { position: relative; height: 280px; width: 100%; }
        
        .kpi-card { 
            transition: all 0.3s ease; 
            border: 1px solid #f1f5f9; 
            background: #ffffff;
        }
        
        .kpi-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 15px -3px rgba(243, 112, 33, 0.1); 
            border-color: var(--padtec-orange);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--padtec-orange); border-radius: 10px; }

        .number-badge {
            background-color: rgba(243, 112, 33, 0.12); 
            padding: 0.4rem 1.2rem;
            border-radius: 1rem;
            display: inline-block;
            min-width: 70px;
            border: 1px solid rgba(243, 112, 33, 0.1);
        }

        @media print { 
            .no-print { display: none !important; }
            body { background: white !important; padding: 0 !important; }
            .letterhead-container { 
                box-shadow: none !important; 
                border: 1px solid #eee !important; 
                margin: 0 !important; 
                width: 100% !important;
                max-width: none !important;
            }
        }

        .btn-padtec-orange {
            background-color: var(--padtec-orange);
            color: white;
            transition: all 0.2s;
        }
        .btn-padtec-orange:hover {
            background-color: #d65d1a;
            transform: scale(1.02);
        }
        .btn-padtec-black {
            background-color: var(--padtec-black);
            color: white;
        }
        .btn-padtec-black:hover {
            background-color: #000000;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- Back Button -->
    <div class="fixed top-4 left-4 z-50">
        <a href="SITE COPE/index.html" class="inline-flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-all shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Voltar
        </a>
    </div>

    <div id="dashboard-content" class="letterhead-container space-y-8 p-10 rounded-sm">
        
        <!-- CABEÇALHO -->
        <div class="flex flex-col md:flex-row justify-between items-start border-b-2 border-slate-100 pb-8 gap-6">
            <div class="flex items-center gap-5">
                <div class="w-2.5 h-14 bg-orange-500 rounded-full"></div>
                <div>
                    <h1 id="main-title" class="text-5xl font-black text-slate-900 tracking-tighter uppercase leading-none">PRODUÇÃO COPE</h1>
                    <p class="text-slate-400 font-bold mt-2 tracking-widest text-xs">RELATÓRIO DE PRODUTIVIDADE | PADTEC</p>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-2 no-print">
                <div class="flex gap-4">
                    <label class="cursor-pointer btn-padtec-orange px-8 py-3.5 rounded-lg font-black transition flex items-center gap-3 shadow-xl text-xs">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        IMPORTAR DADOS
                        <input type="file" id="fileInput" class="hidden" accept=".xls,.xlsx,.csv">
                    </label>
                    
                    <button onclick="downloadPDF()" class="btn-padtec-black px-8 py-3.5 rounded-lg font-black transition flex items-center gap-3 shadow-xl text-xs">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        EXPORTAR PDF
                    </button>
                </div>
                <div class="text-right">
                    <p id="data-referencia-display" class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mr-1">Data Referência: --/--/---- a --/--/----</p>
                </div>
            </div>
        </div>

        <!-- CARDS DE KPI (TOP ROW - 5x1 GRID) -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-8">
            <!-- VOLUME TOTAL (2 Colunas) -->
            <div class="kpi-card md:col-span-2 p-8 rounded-2xl flex flex-col justify-center items-center relative overflow-hidden text-center shadow-sm">
                <div class="absolute top-0 right-0 w-20 h-20 bg-slate-50 rounded-bl-full opacity-50"></div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-4">Total de Tickets</p>
                <div class="number-badge">
                    <h2 id="kpi-total" class="text-[66px] font-black text-slate-800 leading-none">0</h2>
                </div>
                
                <div class="flex gap-6 mt-8 w-full justify-center">
                    <div class="text-center px-2">
                        <p id="stat-agregadores-val" class="text-[33px] font-black text-slate-700 leading-none">0</p>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mt-2">Agregadores</p>
                    </div>
                    <div class="h-8 w-px bg-slate-200"></div>
                    <div class="text-center px-2">
                        <p id="stat-agregado-val" class="text-[33px] font-black text-slate-700 leading-none">0</p>
                        <p class="text-[9px] font-bold text-slate-400 uppercase mt-2">Agregado</p>
                    </div>
                </div>
                <div class="w-16 h-1.5 bg-orange-500/20 rounded-full mt-6"></div>
            </div>

            <!-- UNIFICADO ESPÍRITO SANTO (3 Colunas - AJUSTADO) -->
            <div class="kpi-card md:col-span-3 p-8 rounded-2xl flex flex-col items-stretch bg-slate-50/20 shadow-sm border-l-4 border-l-orange-500 overflow-hidden">
                <div class="flex flex-col gap-3 flex-1"> <!-- gap reduzido de 6 para 3 para "subir" as listas -->
                    <!-- Top Section: Total -->
                    <div class="flex items-end justify-between border-b-2 border-slate-100/50 pb-2"> <!-- pb reduzido de 4 para 2 -->
                        <div>
                            <p class="text-[10px] font-black text-orange-600 uppercase tracking-[0.2em] leading-tight mb-2">TOTAL ESPÍRITO SANTO</p>
                            <div class="number-badge">
                                <!-- Tamanho reduzido em 30%: de 66px para 46px -->
                                <h2 id="kpi-es" class="text-[46px] font-black text-slate-800 leading-none">0</h2>
                            </div>
                        </div>
                        <div class="hidden md:block">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500/20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                    </div>
                    
                    <!-- Bottom Section: Listas -->
                    <div class="flex flex-col md:flex-row gap-10 items-start">
                        <!-- Ranking Cidades -->
                        <div class="flex-1 w-full min-w-0">
                            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 bg-orange-500 rounded-sm"></span>
                                CIDADES EM FOCO
                            </p>
                            <div id="top-cities-es" class="flex flex-col gap-2 h-[125px] overflow-y-auto pr-2 custom-scrollbar">
                                <p class="text-slate-300 text-xs italic py-2">Aguardando importação...</p>
                            </div>
                        </div>

                        <!-- Ranking Causas ES -->
                        <div class="flex-1 w-full min-w-0 md:pl-10 md:border-l-2 md:border-slate-100">
                            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                                <span class="w-2 h-2 bg-slate-800 rounded-sm"></span>
                                PRINCIPAIS CAUSAS ES
                            </p>
                            <div id="causas-es-list-container" class="space-y-1.5 h-[125px] overflow-y-auto pr-2 custom-scrollbar">
                                <p class="text-slate-300 text-[10px] italic py-2">Aguardando importação...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANÁLISE OPERACIONAL -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- LISTA DE CAUSAS GERAL -->
            <div class="p-8 border border-slate-100 rounded-2xl bg-white shadow-sm">
                <div class="flex items-center gap-3 mb-8 border-b border-slate-50 pb-4">
                    <div class="w-1.5 h-5 bg-orange-500"></div>
                    <h3 class="font-black text-slate-800 uppercase text-xs tracking-[0.2em]">Principais Causas Gerais</h3>
                </div>
                <div id="causas-list-container" class="space-y-4 h-[300px] overflow-y-auto pr-3 custom-scrollbar">
                    <p class="text-center text-slate-300 text-xs italic py-24 uppercase tracking-widest font-black">Aguardando processamento...</p>
                </div>
            </div>

            <!-- CATEGORIZAÇÃO DE TAGS -->
            <div class="p-8 border border-slate-100 rounded-2xl bg-white shadow-sm">
                <div class="flex items-center gap-3 mb-8 border-b border-slate-50 pb-4">
                    <div class="w-1.5 h-5 bg-orange-500"></div>
                    <h3 class="font-black text-slate-800 uppercase text-xs tracking-[0.2em]">Distribuição de Tags</h3>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 h-[300px]">
                    <!-- Operacional -->
                    <div class="bg-slate-50 border-2 border-slate-900 rounded-xl p-4 flex flex-col justify-center gap-4 shadow-md overflow-hidden">
                        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] text-center">Operacionais</h4>
                        <div class="flex justify-around items-center gap-2">
                            <div class="text-center flex-1 min-w-0">
                                <div class="number-badge mb-2">
                                    <p id="tag-adm-val" class="text-[26px] font-black text-slate-800 leading-none">0</p>
                                </div>
                                <p class="text-[10px] font-black text-slate-400 uppercase truncate">ADM COPE</p>
                            </div>
                            <div class="h-8 w-0.5 bg-slate-200"></div>
                            <div class="text-center flex-1 min-w-0">
                                <div class="number-badge mb-2">
                                    <p id="tag-desag-val" class="text-[26px] font-black text-slate-800 leading-none">0</p>
                                </div>
                                <p class="text-[10px] font-black text-slate-400 uppercase truncate">DESAGREGADO</p>
                            </div>
                        </div>
                    </div>

                    <!-- Salas de Crise -->
                    <div class="bg-orange-50 border-2 border-orange-500 rounded-xl p-4 flex flex-col justify-center gap-4 shadow-md overflow-hidden">
                        <h4 class="text-[10px] font-black text-orange-600 uppercase tracking-[0.2em] text-center">Salas de Crise</h4>
                        <div class="flex justify-around items-center gap-2">
                            <div class="text-center flex-1 min-w-0">
                                <div class="number-badge mb-2" style="background-color: rgba(243, 112, 33, 0.2);">
                                    <p id="tag-sala-cope-val" class="text-[26px] font-black text-orange-700 leading-none">0</p>
                                </div>
                                <p class="text-[10px] font-black text-orange-400 uppercase truncate">Salas COPE</p>
                            </div>
                            <div class="h-8 w-0.5 bg-orange-200"></div>
                            <div class="text-center flex-1 min-w-0">
                                <div class="number-badge mb-2" style="background-color: rgba(243, 112, 33, 0.2);">
                                    <p id="tag-sala-noc-val" class="text-[26px] font-black text-orange-700 leading-none">0</p>
                                </div>
                                <p class="text-[10px] font-black text-orange-400 uppercase truncate">Salas NOC</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROGRESSÃO E REGIÕES -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="p-8 border border-slate-100 rounded-2xl bg-white shadow-sm">
                <h3 class="font-black text-slate-800 mb-8 text-center uppercase text-xs tracking-[0.2em] border-b border-slate-50 pb-4">Top 5 Regiões</h3>
                <div class="chart-container">
                    <canvas id="regioesChart"></canvas>
                </div>
            </div>
            <div class="p-8 border border-slate-100 rounded-2xl bg-white shadow-sm">
                <h3 class="font-black text-slate-800 mb-8 text-center uppercase text-xs tracking-[0.2em] border-b border-slate-50 pb-4">Progressão Diária</h3>
                <div class="chart-container">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- RODAPÉ TIMBRADO -->
        <div class="mt-16 pt-10 border-t-2 border-slate-100 flex flex-row justify-between items-end opacity-70 pb-6">
            <div class="space-y-2">
                <p class="text-[14px] font-black uppercase tracking-[0.4em] text-slate-900 leading-none">PADTEC S.A.</p>
                <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 leading-none">Campinas - São Paulo, Brasil</p>
            </div>
            
            <div class="text-right space-y-2 pr-2">
                <p class="text-[12px] font-black tracking-[0.2em] text-slate-900 leading-none uppercase">+55 19 2104-9700</p>
                <p class="text-[12px] font-black tracking-[0.2em] text-slate-900 leading-none uppercase">WWW.PADTEC.COM.BR</p>
                <div class="flex gap-4 justify-end mt-4">
                    <div class="w-12 h-1.5 bg-orange-500 rounded-full shadow-sm"></div>
                    <div class="w-12 h-1.5 bg-slate-800 rounded-full shadow-sm"></div>
                    <div class="w-12 h-1.5 bg-slate-200 rounded-full shadow-sm"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        /* JavaScript Integrado */
        const apiKey = ""; 
        let charts = {};
        const CIDADES_ES_ALVO = ["VIANA", "CACHOEIRO DE ITAPEMERIM", "GUARAPARI", "SAO MATEUS", "SANTA MARIA DE JETIBA", "ARACRUZ"];

        document.getElementById('fileInput').addEventListener('change', handleFile);

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheet];
                
                const rawRows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                let headerRowIndex = rawRows.findIndex(row => 
                    row && row.some(cell => String(cell).toLowerCase().includes('causa'))
                );
                
                if (headerRowIndex === -1) headerRowIndex = 0;
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: headerRowIndex });
                processData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            const stats = {
                totalProducao: 0, agregado: 0, agregadores: 0,
                adm: 0, desag: 0, criseC: 0, criseNoc: 0,
                esTotal: 0, esCities: {}, allDates: []
            };

            const causasMap = {};
            const causasESMap = {};
            const regioesMap = {};
            const timelineMap = {};

            data.forEach(row => {
                const aggrColumn = String(row['Agregação'] || '').trim();
                const aggrLower = aggrColumn.toLowerCase();

                if (aggrLower === 'agregado') {
                    stats.agregado++;
                    return; 
                } else {
                    if (aggrColumn === "" || aggrColumn === "null" || aggrColumn === "undefined") {
                        stats.agregadores++;
                    }
                    stats.totalProducao++;
                }

                const tag = String(row['Tag'] || '').toUpperCase();
                if (tag.includes("ADM COPE")) stats.adm++;
                if (tag.includes("DESAGREGADO")) stats.desag++;
                const isSalaCrise = tag.includes("SALA DE CRISE");
                if (isSalaCrise) {
                    if (/\bC\b/.test(tag) || tag.includes("CRISE C")) stats.criseC++;
                    else if (/\d+/.test(tag)) stats.criseNoc++;
                }

                const areaRede = String(row['Área Rede'] || '').toUpperCase();
                const causa = String(row['Causa'] || 'NÃO INFORMADO').trim().toUpperCase();
                const cidadeEncontrada = CIDADES_ES_ALVO.find(c => areaRede.includes(c));
                if (cidadeEncontrada) {
                    stats.esTotal++;
                    stats.esCities[cidadeEncontrada] = (stats.esCities[cidadeEncontrada] || 0) + 1;
                    causasESMap[causa] = (causasESMap[causa] || 0) + 1;
                }

                const dateStr = row['Data Fim'];
                if (dateStr) {
                    const parts = String(dateStr).split(' ')[0].split(/[-/]/);
                    if (parts.length === 3) {
                        let d = parts[0].length === 4 ? new Date(parts[0], parts[1]-1, parts[2]) : new Date(parts[2], parts[1]-1, parts[0]);
                        if (!isNaN(d)) {
                            stats.allDates.push(d);
                            const key = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
                            timelineMap[key] = (timelineMap[key] || 0) + 1;
                        }
                    }
                }

                causasMap[causa] = (causasMap[causa] || 0) + 1;
                let r = String(row['Área Rede'] || 'N/A').replace(/-/g, '').trim().toUpperCase();
                if (r && r !== '-') regioesMap[r] = (regioesMap[r] || 0) + 1;
            });

            const sortedCitiesES = Object.entries(stats.esCities).sort((a, b) => b[1] - a[1]);
            const sortedCausas = Object.entries(causasMap).sort((a,b) => b[1]-a[1]).slice(0, 15);
            const sortedCausasES = Object.entries(causasESMap).sort((a,b) => b[1]-a[1]).slice(0, 10);
            const topRegioes = Object.entries(regioesMap).sort((a,b) => b[1]-a[1]).slice(0, 5);
            const sortedTimeline = Object.entries(timelineMap).sort((a,b) => {
                const [d1, m1] = a[0].split('/').map(Number);
                const [d2, m2] = b[0].split('/').map(Number);
                return (m1 * 100 + d1) - (m2 * 100 + d2);
            });

            document.getElementById('kpi-total').innerText = stats.totalProducao;
            document.getElementById('stat-agregadores-val').innerText = stats.agregadores;
            document.getElementById('stat-agregado-val').innerText = stats.agregado;
            document.getElementById('kpi-es').innerText = stats.esTotal;
            document.getElementById('tag-adm-val').innerText = stats.adm;
            document.getElementById('tag-desag-val').innerText = stats.desag;
            document.getElementById('tag-sala-cope-val').innerText = stats.criseC;
            document.getElementById('tag-sala-noc-val').innerText = stats.criseNoc;

            if (stats.allDates.length > 0) {
                const minDate = new Date(Math.min(...stats.allDates));
                const maxDate = new Date(Math.max(...stats.allDates));
                document.getElementById('data-referencia-display').innerText = `Data Referência: ${minDate.toLocaleDateString('pt-PT')} a ${maxDate.toLocaleDateString('pt-PT')}`;
            }

            const esContainer = document.getElementById('top-cities-es');
            esContainer.innerHTML = sortedCitiesES.length > 0 ? sortedCitiesES.map(([city, val]) => `
                <div class="bg-white p-2 px-3 rounded-xl border border-slate-100 flex items-center gap-3 shadow-sm w-full group hover:border-orange-500 transition-all mb-1">
                    <div class="bg-slate-900 text-white min-w-[34px] py-0.5 rounded-lg font-black text-[10px] text-center group-hover:bg-orange-600 transition-colors">${val}</div>
                    <span class="font-black text-slate-700 text-[9px] uppercase tracking-widest leading-tight whitespace-normal overflow-visible">${city}</span>
                </div>
            `).join('') : `<p class="text-slate-300 text-[10px] italic py-4">Sem dados regionais ES</p>`;

            const renderList = (containerId, dataArr, total) => {
                const container = document.getElementById(containerId);
                container.innerHTML = dataArr.length > 0 ? dataArr.map(([causa, val]) => `
                    <div class="flex items-center gap-3 group p-2 hover:bg-slate-50 rounded-xl transition-all border-l-4 border-slate-100 hover:border-orange-500 mb-1">
                        <div class="min-w-[34px] bg-slate-100 text-slate-800 text-center py-0.5 px-2 rounded-lg font-black text-[10px] group-hover:bg-slate-900 group-hover:text-white transition-all">${val}</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-[9px] font-black text-slate-600 uppercase leading-snug mb-1.5 whitespace-normal overflow-visible">${causa}</p>
                            <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                <div class="bg-orange-500 h-full rounded-full transition-all duration-1000" style="width: ${(val/total*100).toFixed(1)}%"></div>
                            </div>
                        </div>
                    </div>
                `).join('') : `<p class="text-center text-slate-300 text-xs italic py-10 font-black">Vazio</p>`;
            };

            renderList('causas-list-container', sortedCausas, stats.totalProducao);
            renderList('causas-es-list-container', sortedCausasES, stats.esTotal);

            updateCharts({
                regioes: { labels: topRegioes.map(x => x[0]), data: topRegioes.map(x => x[1]) },
                timeline: { labels: sortedTimeline.map(x => x[0]), data: sortedTimeline.map(x => x[1]) }
            });
        }

        function updateCharts(payload) {
            Object.values(charts).forEach(c => c.destroy());
            const commonOptions = { 
                maintainAspectRatio: false, plugins: { legend: { display: false } },
                scales: { 
                    y: { grid: { color: '#f1f5f9' }, border: { display: false }, ticks: { font: { size: 10, weight: '700' } } },
                    x: { grid: { display: false }, border: { display: false }, ticks: { font: { size: 10, weight: '700' } } }
                }
            };
            charts.regioes = new Chart(document.getElementById('regioesChart'), { type: 'bar', data: { labels: payload.regioes.labels, datasets: [{ data: payload.regioes.data, backgroundColor: '#1e293b', borderRadius: 4, barThickness: 15 }] }, options: { ...commonOptions, indexAxis: 'y' } });
            charts.timeline = new Chart(document.getElementById('timelineChart'), { type: 'line', data: { labels: payload.timeline.labels, datasets: [{ data: payload.timeline.data, borderColor: '#F37021', backgroundColor: 'rgba(243, 112, 33, 0.08)', fill: true, tension: 0.4, pointRadius: 5, pointBackgroundColor: '#fff', pointBorderWidth: 3 }] }, options: commonOptions });
        }

        async function downloadPDF() {
            const element = document.getElementById('dashboard-content');
            const buttons = document.querySelectorAll('.no-print');
            buttons.forEach(b => b.style.display = 'none');
            
            const opt = { 
                margin: [10, 10, 10, 10], 
                filename: `Relatorio_Producao_COPE_Padtec.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    letterRendering: true,
                    scrollY: 0
                }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            try {
                const originalStyleWidth = element.style.width;
                const originalMaxWidth = element.style.maxWidth;
                element.style.width = '1120px';
                element.style.maxWidth = 'none';
                await html2pdf().set(opt).from(element).save();
                element.style.width = originalStyleWidth;
                element.style.maxWidth = originalMaxWidth;
            } catch (err) {
                console.error("Erro ao gerar PDF:", err);
            } finally {
                buttons.forEach(b => b.style.display = 'flex');
            }
        }
    </script>
</body>
</html>